# Workflow de validation CI pour Flutter/Python

name: Flutter/Python CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:

jobs:
  flutter_test:
    name: Test Flutter
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.3'  # Version exacte utilisée en local avec Dart 3.9.2
          channel: 'stable'
          
      - name: Check Dart SDK version
        run: |
          cd flutter_app
          flutter --version
          
      - name: Install dependencies
        run: |
          cd flutter_app
          flutter pub get
          
      - name: Verify formatting
        run: |
          cd flutter_app
          flutter format --set-exit-if-changed .
          
      - name: Analyze project source
        run: |
          cd flutter_app
          flutter analyze
          
      - name: Run tests
        run: |
          cd flutter_app
          flutter test
  
  python_test:
    name: Test Python
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
      - name: Install dependencies & run tests for python_backend
        run: |
          cd python_backend
          # Vérifions où se trouve Poetry
          which poetry || echo "Poetry not found in PATH"
          # Installe les dépendances avec l'option explicite dev
          poetry config virtualenvs.create true
          poetry install
          # Ajout explicite de pytest
          poetry add pytest --group dev
          # Lister les paquets installés pour vérification
          poetry show
          # Exécution du test
          poetry run python -m pytest tests/ -v
          
      - name: Install dependencies & run tests for web_backend
        run: |
          cd web_backend
          # Vérifions où se trouve Poetry
          which poetry || echo "Poetry not found in PATH"
          # Installe les dépendances avec l'option explicite dev
          poetry config virtualenvs.create true
          poetry install
          # Ajout explicite de pytest
          poetry add pytest --group dev
          # Lister les paquets installés pour vérification
          poetry show
          # Exécution du test
          poetry run python -m pytest tests/ -v
